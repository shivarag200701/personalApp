// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}


model User {
  id              Int             @id @default(autoincrement())
  username        String          @unique
  email           String          @unique
  hashedPassword      String?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  todos           Todo[]
  isPasswordSet   Boolean         @default(false)

  oauthAccounts   OAuthAccount[]
  preference      UserPrefrence?
  notfications    Notifications[]
}


model UserPrefrence {
  id            Int             @id @default(autoincrement())
  user          User     @relation(fields: [userId], references: [id])
  userId        Int      @unique

  // Notifications Channel preferences
  emailEnabled    Boolean @default(true)
  smsEnabled      Boolean @default(true)
  pushEnabled     Boolean @default(true)
  inAppEnabled    Boolean @default(true)

  //notification remainders
  taskRemainders  Boolean @default(true)

  //Timing preferences
  reminderBefore  Int     @default(30) //miutes before due time
  dailyDigest     Boolean  @default(false)
  digestTime      String?  // "09:00" for 9 AM

  // Contact info
  phoneNumber     String?
  pushToken       String?  // FCM token for mobile
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

}

model Notifications {
  id            Int             @id @default(autoincrement())
  user          User     @relation(fields: [userId], references: [id])
  userId        Int      @unique

  type          String  //"for now only task_remainder"
  title         String
  message       String

  //Related entites
  todoId        Int?
  todo          Todo?    @relation(fields: [todoId],references: [id])

  // Delivery status
  channels        String[] // ["EMAIL", "PUSH", "IN_APP"]
  status          String   @default("PENDING") // PENDING, SENT, FAILED
  sentAt          DateTime?
  readAt          DateTime?
  
  // Metadata
  metadata        Json?    // Additional data
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([userId,readAt])      //useful for geting all unread notifications for a user
  @@index([status])             //useful for the pending notification jobs to be added in the queue
}

model Todo {
  id            Int         @id @default(autoincrement())
  title         String
  description   String
  priority      String?    
  dueOn         DateTime? @db.Date
  dueAt         DateTime? @db.Timestamp(3)
  category      String
  user          User        @relation(fields: [userId], references: [id])
  userId        Int    
  completed     Boolean     @default(false)
  completedAt   DateTime?
  color         String?
  isAllDay      Boolean     @default(false)
  order         Int?

  //Recurring tasks fields
  isRecurring         Boolean     @default(false)
  recurrencePattern String? // "daily", "weekly", "monthly", "yearly"
  recurrenceInterval Int?         @default(1) // e.g. 7 for weekly, 30 for monthly
  recurrenceEndDate DateTime?
  parentRecurringId Int?
  nextOccurrence DateTime?
  createdAt DateTime @default(now())
  updatedAt DateTime? @updatedAt

  notifications Notifications[]
}

model OAuthAccount {
  id Int @id @default(autoincrement())
  userId Int
  user User @relation(fields: [userId], references: [id])
  provider String
  providerAccountId String
  refreshToken String?
  accessToken String?
  tokenExpiresAt DateTime?
  scope String?
  idToken String?
  createdAt DateTime @default(now())
  updatedAt DateTime? @updatedAt
  pictureUrl String?

  @@unique([userId, provider])
}